<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="snarkjs.min.js">   </script>
    <script>
        const contractAddr = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        let accounts;
        const loginWithMetaMask = async () => {
            accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            console.log("conn suc");
        }
        const submit = async (ans) => {
            const account = accounts[0];
            const r = await calcPrf(ans);
            const get_zk_prf = r.prf;
            const zk_prf = {
                a: [
                    get_zk_prf.pi_a[0],
                    get_zk_prf.pi_a[1]
                ],
                b: [
                    [
                        get_zk_prf.pi_b[0][1],
                        get_zk_prf.pi_b[0][0]
                    ],
                    [
                        get_zk_prf.pi_b[1][1],
                        get_zk_prf.pi_b[1][0]
                    ]
                ],
                c: [
                    get_zk_prf.pi_c[0],
                    get_zk_prf.pi_c[1]
                ]
            };
            const web3 = await new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
            const abi = [
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "_verifier",
                            "type": "address"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "certificates",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "checkCertificate",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "components": [
                                {
                                    "internalType": "uint256[2]",
                                    "name": "a",
                                    "type": "uint256[2]"
                                },
                                {
                                    "internalType": "uint256[2][2]",
                                    "name": "b",
                                    "type": "uint256[2][2]"
                                },
                                {
                                    "internalType": "uint256[2]",
                                    "name": "c",
                                    "type": "uint256[2]"
                                }
                            ],
                            "internalType": "struct ZkAns.ZKP",
                            "name": "zkp",
                            "type": "tuple"
                        },
                        {
                            "internalType": "uint256",
                            "name": "ans",
                            "type": "uint256"
                        }
                    ],
                    "name": "submitAns",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "verifier",
                    "outputs": [
                        {
                            "internalType": "contract Verifier",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ];
            const contract = await new web3.eth.Contract(abi, contractAddr);
            const result = await contract.methods.submitAns(zk_prf, r.pub[0]).send({ from: account, gas: 30000000 });
            console.log(result);
            const result_ = await contract.methods.checkCertificate().call({ from: account, gas: 30000000 });
            console.log("certificate:", result_);
        }
        const calcPrf = async (ans) => {
            const rnd = Math.floor(Math.random() * 10000000);// a suck random number
            const { proof, publicSignals } =
                await snarkjs.groth16.fullProve({ ans: ans, nonce: rnd }, "circuit.wasm?ans=" + ans, "circuit_final.zkey");
            return { prf: proof, pub: publicSignals };
        }
    </script>
</head>

<body>
    <header>
        <h1>ZkAns</h1>
    </header>
    <nav>
        <input type="button" id="loginButton" onclick="loginWithMetaMask()" value="conn to MetaMask">
    </nav>
    <hr>
    <section>
        <input type="text" id="ansText">
        <input type="button" id="submitButton" onclick="submit(document.getElementById('ansText').value)"
            value="submit">
    </section>
</body>

</html>